name: Staging Merge
on:
  push:
    branches-ignore:
      - 'master'

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
    - name: Check staging merge
      run: |
        cd ${GITHUB_WORKSPACE}
        merge_destination_branch=staging
        merge_source_branch=$(git rev-parse --abbrev-ref $GITHUB_SHA)
        merge_base=$(git merge-base $merge_destination_branch $merge_source_branch)
        if [[ $merge_base = $GITHUB_SHA ]]; then
          DESCRIPTION=$merge_source_branch is merged into $merge_destination_branch;
          STATE=success;
        else
          DESCRIPTION=$merge_source_branch is not merged into $merge_destination_branch;
          STATE=pending;
        fi
        curl --request POST \
          --url https://api.github.com/repos/${{ github.repository }}/statuses/$GITHUB_SHA \
          --header "authorization: Bearer $GITHUB_TOKEN" \
          --header 'content-type: application/json' \
          --data "{\"state\":\"$STATE\",\"description\":\"$DESCRIPTION\",\"context\":\"checks.staging_merge\"}"
